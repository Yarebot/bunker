import asyncio
import logging
import random
import uuid
from typing import Dict, List, Optional, Set
from dataclasses import dataclass, field

from aiogram import Bot, Dispatcher, F, types
from aiogram.filters import Command
from aiogram.types import (
    InlineKeyboardButton,
    InlineKeyboardMarkup,
    CallbackQuery,
    Message
)
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.exceptions import TelegramForbiddenError

# ==========================================
# 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# ==========================================

# ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô –¢–û–ö–ï–ù
API_TOKEN = "8227224834:AAG5z7ztfDzmrxoxvBYqCRg8Uw-MVtwu75U"

logging.basicConfig(level=logging.INFO)
bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# ==========================================
# 2. –ë–ê–ó–ê –î–ê–ù–ù–´–• –ö–û–ù–¢–ï–ù–¢–ê –ò –ö–ê–¢–ê–°–¢–†–û–§
# ==========================================

CATASTROPHES = [
    "‚ò¢Ô∏è **–Ø–¥–µ—Ä–Ω–∞—è –∑–∏–º–∞.** –ú–∏—Ä —É–Ω–∏—á—Ç–æ–∂–µ–Ω —è–¥–µ—Ä–Ω—ã–º–∏ —É–¥–∞—Ä–∞–º–∏. –°–Ω–∞—Ä—É–∂–∏ —Ä–∞–¥–∏–∞—Ü–∏—è, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ -50¬∞C, –≤–µ—á–Ω–∞—è —Ç—å–º–∞. –í—ã–∂–∏–≤—É—Ç —Ç–æ–ª—å–∫–æ —Ç–µ, –∫—Ç–æ –ø–æ–ª–µ–∑–µ–Ω –≤ –∑–∞–º–∫–Ω—É—Ç–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –∏ —É–º–µ–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç–µ—Ö–Ω–∏–∫–æ–π.",
    "üßü **–ó–æ–º–±–∏-–∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å.** –í–∏—Ä—É—Å –±–µ—à–µ–Ω—Å—Ç–≤–∞ –≤—ã–∫–æ—Å–∏–ª 99% –Ω–∞—Å–µ–ª–µ–Ω–∏—è. –ë—É–Ω–∫–µ—Ä –æ–∫—Ä—É–∂–µ–Ω —Ç–æ–ª–ø–∞–º–∏ –±—ã—Å—Ç—Ä—ã—Ö –∏ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã—Ö –∑–∞—Ä–∞–∂–µ–Ω–Ω—ã—Ö. –ù—É–∂–Ω—ã –±–æ–π—Ü—ã, –º–µ–¥–∏–∫–∏ –∏ —Ç–µ, –∫—Ç–æ —É–º–µ–µ—Ç —É–∫—Ä–µ–ø–ª—è—Ç—å –æ–±–æ—Ä–æ–Ω—É.",
    "üåä **–í—Å–µ–º–∏—Ä–Ω—ã–π –ø–æ—Ç–æ–ø.** –°—É—à–∏ –±–æ–ª—å—à–µ –Ω–µ—Ç. –ë—É–Ω–∫–µ—Ä ‚Äî —ç—Ç–æ –≥–µ—Ä–º–µ—Ç–∏—á–Ω–∞—è –ø–æ–¥–≤–æ–¥–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è –Ω–∞ –¥–Ω–µ –æ–∫–µ–∞–Ω–∞. –†–µ—Å—É—Ä—Å—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã, –¥–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ—Å—Å–∞–ª—å–Ω–æ–µ. –í–∞–∂–Ω—ã –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ —É–º–µ–Ω–∏–µ —á–∏–Ω–∏—Ç—å —Å–∏—Å—Ç–µ–º—ã –∂–∏–∑–Ω–µ–æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è.",
    "ü§ñ **–í–æ—Å—Å—Ç–∞–Ω–∏–µ –º–∞—à–∏–Ω.** –ò–ò –∑–∞—Ö–≤–∞—Ç–∏–ª –ø–ª–∞–Ω–µ—Ç—É. –î—Ä–æ–Ω—ã-–æ—Ö–æ—Ç–Ω–∏–∫–∏ –∏—â—É—Ç –≤—ã–∂–∏–≤—à–∏—Ö. –õ—é–±–∞—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞ —Å–Ω–∞—Ä—É–∂–∏ –æ–ø–∞—Å–Ω–∞. –í —Ü–µ–Ω–µ —Ö–∞–∫–µ—Ä—ã, –º–µ—Ö–∞–Ω–∏–∫–∏ –∏ –ª—é–¥–∏ —Å –Ω–∞–≤—ã–∫–∞–º–∏ –≤—ã–∂–∏–≤–∞–Ω–∏—è –±–µ–∑ –≥–∞–¥–∂–µ—Ç–æ–≤.",
    "‚òÑÔ∏è **–ü–∞–¥–µ–Ω–∏–µ –∞—Å—Ç–µ—Ä–æ–∏–¥–∞.** –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ –æ—Ç—Ä–∞–≤–ª–µ–Ω–∞ —Ç–æ–∫—Å–∏—á–Ω–æ–π –ø—ã–ª—å—é, –∫–∏—Å–ª–æ—Ä–æ–¥–∞ —Å–Ω–∞—Ä—É–∂–∏ –Ω–µ—Ç. –ë—É–Ω–∫–µ—Ä –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–π –±–∏–æ—Å—Ñ–µ—Ä–æ–π –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 50 –ª–µ—Ç. –ù—É–∂–Ω—ã –∞–≥—Ä–æ–Ω–æ–º—ã, –≥–µ–Ω–µ—Ç–∏–∫–∏ –∏ –∏–Ω–∂–µ–Ω–µ—Ä—ã."
]

CONTENT = {
    "professions": [
        "–í—Ä–∞—á-—Ö–∏—Ä—É—Ä–≥", "–£—á–∏—Ç–µ–ª—å —Ñ–∏–∑–∏–∫–∏", "–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫ 6-–≥–æ —Ä–∞–∑—Ä—è–¥–∞", "–ê–≥—Ä–æ–Ω–æ–º", "–í–µ–±-–¥–∏–∑–∞–π–Ω–µ—Ä-—Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä",
        "–°–ø–µ—Ü–Ω–∞–∑–æ–≤–µ—Ü –ì–†–£ –≤ –æ—Ç—Å—Ç–∞–≤–∫–µ", "–°–≤—è—â–µ–Ω–Ω–∏–∫", "–®–µ—Ñ-–ø–æ–≤–∞—Ä", "–ê–≤—Ç–æ–º–µ—Ö–∞–Ω–∏–∫", "–ü—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç",
        "–•–∏–º–∏–∫-—Ç–µ—Ö–Ω–æ–ª–æ–≥", "–¢–∏–∫–¢–æ–∫ –±–ª–æ–≥–µ—Ä (5 –º–ª–Ω)", "–ß–µ–ª–æ–≤–µ–∫ –±–µ–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –∂–∏—Ç–µ–ª—å—Å—Ç–≤–∞", "–î–µ–ø—É—Ç–∞—Ç –ì–æ—Å–¥—É–º—ã", "–í–µ—Ç–µ—Ä–∏–Ω–∞—Ä",
        "–ì–ª–∞–≤–Ω—ã–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –≥–æ—Ä–æ–¥–∞", "–≠–ª–µ–∫—Ç—Ä–∏–∫", "–≠—Å–∫–æ—Ä—Ç–Ω–∏—Ü–∞", "–§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π —Å—É–¥—å—è", "–ü–∏–ª–æ—Ç –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–π –∞–≤–∏–∞—Ü–∏–∏",
        "–ú—è—Å–Ω–∏–∫ –Ω–∞ —Ä—ã–Ω–∫–µ", "–ü–µ—Ä–µ–≤–æ–¥—á–∏–∫ —Å –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ –∏ –∞—Ä–∞–±—Å–∫–æ–≥–æ", "–ê—Å—Ç—Ä–æ—Ñ–∏–∑–∏–∫", "–§–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä", "–ì—Ä–æ–±–æ–≤—â–∏–∫",
        "–•–∞–∫–µ—Ä (Black Hat)", "–£–±–æ—Ä—â–∏—Ü–∞ –≤ –ì–∞–∑–ø—Ä–æ–º–µ", "–ì–µ–æ–ª–æ–≥-—Ä–∞–∑–≤–µ–¥—á–∏–∫", "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—å", "–°—Ç—Ä–∏–ø—Ç–∏–∑–µ—Ä—à–∞", "–ì–µ–Ω–µ—Ç–∏–∫",
        "–í–æ–¥–∏—Ç–µ–ª—å –∞–≤—Ç–æ–±—É—Å–∞", "–û—Ö—Ä–∞–Ω–Ω–∏–∫ –≤ –ü—è—Ç–µ—Ä–æ—á–∫–µ", "–¢–∞—Ç—É-–º–∞—Å—Ç–µ—Ä", "–§–µ—Ä–º–µ—Ä"
    ],
    "health": [
        "–ò–¥–µ–∞–ª—å–Ω–æ –∑–¥–æ—Ä–æ–≤ (–∫–∞–∫ –∫–æ—Å–º–æ–Ω–∞–≤—Ç)", "–ë—Ä–æ–Ω—Ö–∏–∞–ª—å–Ω–∞—è –∞—Å—Ç–º–∞ (—Ç—è–∂–µ–ª–∞—è —Ñ–æ—Ä–º–∞)", "–ë–µ—Å–ø–ª–æ–¥–∏–µ", "–í–ò–ß-–∏–Ω—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ—Ä–∞–ø–∏—é)",
        "–ü–∞—Ä–∞–Ω–æ–π—è–ª—å–Ω–∞—è —à–∏–∑–æ—Ñ—Ä–µ–Ω–∏—è", "–°–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç 1 —Ç–∏–ø–∞ (–∏–Ω—Å—É–ª–∏–Ω–æ–∑–∞–≤–∏—Å–∏–º—ã–π)", "–†–∞–∫ –ª–µ–≥–∫–∏—Ö (3 —Å—Ç–∞–¥–∏—è, —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω–∞—è)",
        "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ª–µ–≤–∞—è –Ω–æ–≥–∞ (–ø—Ä–æ—Ç–µ–∑)", "–¢–æ—Ç–∞–ª—å–Ω–∞—è –≥–ª—É—Ö–æ—Ç–∞", "–°–ª–µ–ø–æ—Ç–∞ –Ω–∞ –æ–¥–∏–Ω –≥–ª–∞–∑", "–•—Ä–æ–Ω–∏—á–µ—Å–∫–∏–π –∞–ª–∫–æ–≥–æ–ª–∏–∑–º (–≤ –∑–∞–≤—è–∑–∫–µ)",
        "–ì–µ—Ä–æ–∏–Ω–æ–≤–∞—è –Ω–∞—Ä–∫–æ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å (–∞–∫—Ç–∏–≤–Ω–∞—è)", "–ö–æ—Ä–æ–Ω–∞–≤–∏—Ä—É—Å (–∞–∫—Ç–∏–≤–Ω–∞—è —Ñ–∞–∑–∞, –∑–∞—Ä–∞–∑–µ–Ω)", "–≠–ø–∏–ª–µ–ø—Å–∏—è (—á–∞—Å—Ç—ã–µ –ø—Ä–∏–ø–∞–¥–∫–∏)",
        "–°–∏–ª—å–Ω–∞—è –∞–ª–ª–µ—Ä–≥–∏—è –Ω–∞ –ø—ã–ª—å –∏ –ø–ª–µ—Å–µ–Ω—å", "–ë–µ—Ä–µ–º–µ–Ω–Ω–∞ (7 –º–µ—Å—è—Ü, –¥–≤–æ–π–Ω—è)", "–ú–æ—Ä–±–∏–¥–Ω–æ–µ –æ–∂–∏—Ä–µ–Ω–∏–µ (180 –∫–≥)",
        "–ê–Ω–æ—Ä–µ–∫—Å–∏—è (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –≤–µ—Å)", "–ó—Ä–µ–Ω–∏–µ -10 (–ø–æ—á—Ç–∏ —Å–ª–µ–ø –±–µ–∑ –æ—á–∫–æ–≤)", "–ì–µ–Ω–∏—Ç–∞–ª—å–Ω—ã–π –≥–µ—Ä–ø–µ—Å", "–°–∏—Ñ–∏–ª–∏—Å (–∑–∞—Ä–∞–∑–µ–Ω)", "–û—Ç–∫—Ä—ã—Ç–∞—è —Ñ–æ—Ä–º–∞ —Ç—É–±–µ—Ä–∫—É–ª–µ–∑–∞",
        "–¢—è–∂–µ–ª—ã–µ –ø–∞–Ω–∏—á–µ—Å–∫–∏–µ –∞—Ç–∞–∫–∏", "–ë–∏–æ–Ω–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ç–µ–∑ —Ä—É–∫–∏", "–ö–∞—Ä–¥–∏–æ—Å—Ç–∏–º—É–ª—è—Ç–æ—Ä (—Ç—Ä–µ–±—É–µ—Ç –∑–∞–º–µ–Ω—ã –±–∞—Ç–∞—Ä–µ–∏)", "–•—Ä–æ–Ω–∏—á–µ—Å–∫–∞—è –±–µ—Å—Å–æ–Ω–Ω–∏—Ü–∞ (–Ω–µ —Å–ø–∏—Ç –ø–æ 3 –¥–Ω—è)"
    ],
    "hobbies": [
        "–í—ã—Ä–∞—â–∏–≤–∞–Ω–∏–µ –æ–≤–æ—â–µ–π –Ω–∞ –≥–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–µ", "–°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–µ–ª—å–±–∞ (–ö–ú–°)", "–û—Ö–æ—Ç–∞ –Ω–∞ –∫—Ä—É–ø–Ω–æ–≥–æ –∑–≤–µ—Ä—è", "–†—ã–±–∞–ª–∫–∞ (–∑–Ω–∞–µ—Ç –≤—Å–µ —É–∑–ª—ã)", "–í—è–∑–∞–Ω–∏–µ —Ç–µ–ø–ª—ã—Ö –≤–µ—â–µ–π",
        "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–∫–µ—Ä", "–†–µ–º–æ–Ω—Ç —Å–ª–æ–∂–Ω–æ–π —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏", "–ö—É–ª–∏–Ω–∞—Ä–∏—è –∏–∑ –ø–æ–¥–Ω–æ–∂–Ω–æ–≥–æ –∫–æ—Ä–º–∞", "–ü–æ–ª–∏–≥–ª–æ—Ç (7 —è–∑—ã–∫–æ–≤)", "–ú–∞—Å—Ç–µ—Ä –æ—Ä–∏–≥–∞–º–∏",
        "–®–∞—Ö–º–∞—Ç—ã (–≥—Ä–æ—Å—Å–º–µ–π—Å—Ç–µ—Ä)", "–¢–∞–π—Å–∫–∏–π –±–æ–∫—Å", "–†–∞–∑–≤–µ–¥–µ–Ω–∏–µ –∫—Ä–æ–ª–∏–∫–æ–≤", "–ò–∑—É—á–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤–æ–π –∞–ª—Ö–∏–º–∏–∏", "–ì–∞–¥–∞–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–∞—Ö –¢–∞—Ä–æ",
        "–ü–∞—Ä–∫—É—Ä", "–§–∏–ª–∞—Ç–µ–ª–∏—Å—Ç (–∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç –º–∞—Ä–∫–∏)", "–ö—É–Ω–¥–∞–ª–∏–Ω–∏-–π–æ–≥–∞", "–í–∏—Ä—Ç—É–æ–∑–Ω–∞—è –∏–≥—Ä–∞ –Ω–∞ –≥–∏—Ç–∞—Ä–µ", "–ö—É—Ä—Å—ã –≤—ã–∂–∏–≤–∞–Ω–∏—è –≤ —Ç–∞–π–≥–µ"
    ],
    "facts": [
        "–û—Ç—Å–∏–¥–µ–ª 8 –ª–µ—Ç –∑–∞ –∫—Ä—É–ø–Ω–æ–µ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ", "–í —à–∫–æ–ª–µ –≤—ã–∏–≥—Ä–∞–ª –≤—Å–µ—Ä–æ—Å—Å–∏–π—Å–∫—É—é –æ–ª–∏–º–ø–∏–∞–¥—É –ø–æ —Ö–∏–º–∏–∏", "–í –ø—Ä–æ—à–ª–æ–º –±—ã–ª –∑–∞–º–µ—á–µ–Ω –≤ –∫–∞–Ω–Ω–∏–±–∞–ª–∏–∑–º–µ (–≤—ã–∂–∏–≤–∞–Ω–∏–µ –≤ –≥–æ—Ä–∞—Ö)",
        "–ü–æ—Å—Ç—Ä–æ–∏–ª —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –±—É–Ω–∫–µ—Ä –Ω–∞ –¥–∞—á–µ (–Ω–æ –Ω–µ —É—Å–ø–µ–ª –¥–æ–µ—Ö–∞—Ç—å)", "–ú–æ–∂–µ—Ç –∑–∞–¥–µ—Ä–∂–∞—Ç—å –¥—ã—Ö–∞–Ω–∏–µ –Ω–∞ 5 –º–∏–Ω—É—Ç", "–í–Ω–µ–±—Ä–∞—á–Ω—ã–π —Å—ã–Ω –æ–ª–∏–≥–∞—Ä—Ö–∞ (–∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Å—á–µ—Ç–∞–º)", "–£–º–µ–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –≤–µ—Ä—Ç–æ–ª–µ—Ç–æ–º",
        "–°–µ—Ä—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø–µ—Ä–≤–æ–π –ø–æ–º–æ—â–∏ –ö—Ä–∞—Å–Ω–æ–≥–æ –ö—Ä–µ—Å—Ç–∞", "–ê–±—Å–æ–ª—é—Ç–Ω–æ –Ω–µ —É–º–µ–µ—Ç —á–∏—Ç–∞—Ç—å –∏ –ø–∏—Å–∞—Ç—å", "–ü–∞–Ω–∏—á–µ—Å–∫–∏ –±–æ–∏—Ç—Å—è —Ç–µ–º–Ω–æ—Ç—ã (–Ω—É–∂–µ–Ω –Ω–æ—á–Ω–∏–∫)",
        "–í–æ–∏–Ω—Å—Ç–≤—É—é—â–∏–π –≤–µ–≥–∞–Ω (–Ω–∞–≤—è–∑—ã–≤–∞–µ—Ç –≤—Å–µ–º)", "IQ 165 (–≥–µ–Ω–∏–π)", "–†–æ–¥–∏–ª—Å—è —Å —Ä—É–¥–∏–º–µ–Ω—Ç–∞—Ä–Ω—ã–º —Ö–≤–æ—Å—Ç–æ–º", "–°–ª—É–∂–∏–ª –≤ —Ç—Ä–µ—Ö –≥–æ—Ä—è—á–∏—Ö —Ç–æ—á–∫–∞—Ö",
        "–°–ª—É—á–∞–π–Ω–æ —É–±–∏–ª —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞ –æ—Ö–æ—Ç–µ –∏ —Å–∫—Ä—ã–ª —ç—Ç–æ", "–ü–æ–¥–ø–æ–ª—å–Ω—ã–π –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–π –º–∏–ª–ª–∏–æ–Ω–µ—Ä", "–í–ª–∞–¥–µ–µ—Ç —Ç–µ—Ö–Ω–∏–∫–∞–º–∏ –±–æ–µ–≤–æ–≥–æ –≥–∏–ø–Ω–æ–∑–∞"
    ],
    "phobias": [
        "–ö–ª–∞—É—Å—Ç—Ä–æ—Ñ–æ–±–∏—è (–±–æ—è–∑–Ω—å –∑–∞–º–∫–Ω—É—Ç—ã—Ö –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤)", "–ê—Ä–∞—Ö–Ω–æ—Ñ–æ–±–∏—è (–ø–∞—É–∫–∏)", "–ì–µ–º–æ—Ñ–æ–±–∏—è (–≤–∏–¥ –∫—Ä–æ–≤–∏ –≤—ã–∑—ã–≤–∞–µ—Ç –æ–±–º–æ—Ä–æ–∫)",
        "–ù–∏–∫—Ç–æ—Ñ–æ–±–∏—è (—Ç–µ–º–Ω–æ—Ç–∞)", "–ê–∫—Ä–æ—Ñ–æ–±–∏—è (–≤—ã—Å–æ—Ç–∞)", "–°–æ—Ü–∏–æ—Ñ–æ–±–∏—è (–±–æ–∏—Ç—Å—è –ª—é–¥–µ–π)", "–ê–∫–≤–∞—Ñ–æ–±–∏—è (–≤–æ–¥–∞, –Ω–µ —É–º–µ–µ—Ç –ø–ª–∞–≤–∞—Ç—å)",
        "–û—Ñ–∏–¥–∏–æ—Ñ–æ–±–∏—è (–∑–º–µ–∏)", "–ê—ç—Ä–æ—Ñ–æ–±–∏—è (–ø–æ–ª–µ—Ç—ã)", "–î–µ–Ω—Ç–æ—Ñ–æ–±–∏—è (—Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏)", "–ú–∏–∑–æ—Ñ–æ–±–∏—è (–ø–∞–Ω–∏—á–µ—Å–∫–∞—è –±–æ—è–∑–Ω—å –º–∏–∫—Ä–æ–±–æ–≤ –∏ –≥—Ä—è–∑–∏)"
    ],
    "luggage": [
        "–ë–æ–ª—å—à–∞—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∞–ø—Ç–µ—á–∫–∞", "–û—Ö–æ—Ç–Ω–∏—á—å–µ —Ä—É–∂—å–µ —Å –ø–∞—Ç—Ä–æ–Ω–∞–º–∏", "–ù–∞–±–æ—Ä —Å–ª–µ—Å–∞—Ä–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤", "–ú–µ—à–æ–∫ —Å–µ–º–µ–Ω–Ω–æ–≥–æ –∫–∞—Ä—Ç–æ—Ñ–µ–ª—è (10 –∫–≥)",
        "–ö–æ–ª–æ–¥–∞ –∏–≥—Ä–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç", "–ê—Ä–º–µ–π—Å–∫–∏–π –ø—Ä–æ—Ç–∏–≤–æ–≥–∞–∑ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏", "–Ø—â–∏–∫ —ç–ª–∏—Ç–Ω–æ–π –≤–æ–¥–∫–∏ (12 –±—É—Ç—ã–ª–æ–∫)", "–ú–æ—â–Ω—ã–π —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ñ–æ–Ω–∞—Ä—å (—Å –¥–∏–Ω–∞–º–æ-–º–∞—à–∏–Ω–æ–π)",
        "–ó–∞—â–∏—â–µ–Ω–Ω—ã–π –Ω–æ—É—Ç–±—É–∫ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–∂–∏–≤–∞–Ω–∏—é",
        "–ù–∞–¥—É–≤–Ω–∞—è –ª–æ–¥–∫–∞", "–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Ç–æ–ø–æ—Ä", "–ö–æ–º–ø–∞—Å –∏ —Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç—ã –º–µ—Å—Ç–Ω–æ—Å—Ç–∏", "–ë–æ–ª—å—à–∞—è —É–ø–∞–∫–æ–≤–∫–∞ –ø—Ä–µ–∑–µ—Ä–≤–∞—Ç–∏–≤–æ–≤",
        "–õ—é–±–∏–º—ã–π –ø–ª—é—à–µ–≤—ã–π –º–∏—à–∫–∞ (—Ç–∞–ª–∏—Å–º–∞–Ω)", "–ê–∫—É—Å—Ç–∏—á–µ—Å–∫–∞—è –≥–∏—Ç–∞—Ä–∞", "–ë–∏–Ω–æ–∫–ª—å –Ω–æ—á–Ω–æ–≥–æ –≤–∏–¥–µ–Ω–∏—è", "–ö–æ—Ä–æ–±–∫–∞ –æ—Ö–æ—Ç–Ω–∏—á—å–∏—Ö —Å–ø–∏—á–µ–∫ (1000 —à—Ç)",
        "–ù–∞–±–æ—Ä –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∫—É—Ö–æ–Ω–Ω—ã—Ö –Ω–æ–∂–µ–π",
        "–†–∞—Ü–∏—è –¥–∞–ª—å–Ω–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è (2 —à—Ç)", "–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω–∞—è —Å–æ–ª–Ω–µ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å", "–£—á–µ–±–Ω–∏–∫ ¬´–ü–æ–ª–µ–≤–∞—è —Ö–∏—Ä—É—Ä–≥–∏—è¬ª", "–ö–∞–ª—å—è–Ω –∏ —Ç–∞–±–∞–∫", "–ù–∞—Å—Ç–æ—è—â–∞—è —è–ø–æ–Ω—Å–∫–∞—è –∫–∞—Ç–∞–Ω–∞"
    ]
}

# ==========================================
# 3. –ú–û–î–ï–õ–ò –î–ê–ù–ù–´–•
# ==========================================

@dataclass
class GameAttribute:
    text: str
    is_revealed: bool = False
    metadata: dict = field(default_factory=dict)

@dataclass
class SpecialCard:
    uid: str
    name: str
    description: str
    effect_type: str # heal, reveal, kick, steal, swap, shield, silence, double_vote, reroll
    icon: str
    is_used: bool = False

@dataclass
class Player:
    user_id: int
    full_name: str
    username: str
    
    profession: GameAttribute = None
    health: GameAttribute = None
    bio: GameAttribute = None
    hobby: GameAttribute = None
    fact: GameAttribute = None
    phobia: GameAttribute = None
    luggage: List[GameAttribute] = field(default_factory=list)
    
    action_cards: List[SpecialCard] = field(default_factory=list)
    
    is_alive: bool = True
    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞ —Ä–∞—É–Ω–¥
    vote_weight: int = 1
    is_shielded: bool = False # –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Ä—Ç
    is_silenced: bool = False # –ó–∞–ø—Ä–µ—Ç –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç/—Ä–∞—Å–∫—Ä—ã—Ç–∏–µ

    dashboard_msg_id: int = None

@dataclass
class GameSession:
    chat_id: int
    players: Dict[int, Player] = field(default_factory=dict)
    state: str = "LOBBY" # LOBBY, GAME, VOTING
    round_number: int = 0
    scenario: str = ""
    votes: Dict[int, int] = field(default_factory=dict)
    voters: Set[int] = field(default_factory=set) # –ö—Ç–æ —É–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ

GAMES: Dict[int, GameSession] = {}
USER_SESSIONS: Dict[int, int] = {} # user_id -> chat_id –∏–≥—Ä—ã

# ==========================================
# 4. –õ–û–ì–ò–ö–ê –ì–ï–ù–ï–†–ê–¶–ò–ò (–ù–û–í–´–ï –ö–ê–†–¢–´!)
# ==========================================

def get_random_card() -> SpecialCard:
    """–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ø–µ—Ü–∫–∞—Ä—Ç —Å —Ä–∞–∑–Ω—ã–º–∏ —à–∞–Ω—Å–∞–º–∏ (–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø—É–ª)"""
    pool = [
        # (–í–µ—Å, –ò–º—è, –û–ø–∏—Å–∞–Ω–∏–µ, –¢–∏–ø, –ò–∫–æ–Ω–∫–∞)
        # --- –ß–∞—Å—Ç—ã–µ (45%) ---
        (15, "üíâ –ü–∞–Ω–∞—Ü–µ—è", "–ü–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–ª–µ—á–∏—Ç—å –ª—é–±—É—é –±–æ–ª–µ–∑–Ω—å —É —Å–µ–±—è –∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ.", "heal", "üíâ"),
        (15, "ü©ª –†–µ–Ω—Ç–≥–µ–Ω", "–£–∑–Ω–∞—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ –∏ –±–∏–æ–ª–æ–≥–∏—é –ª—é–±–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –≤ –õ–°.", "reveal", "ü©ª"),
        (15, "üß§ –ö–∞—Ä–º–∞–Ω–Ω–∏–∫", "–£–∫—Ä–∞—Å—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç —É –∏–≥—Ä–æ–∫–∞.", "steal", "üß§"),
        
        # --- –†–µ–¥–∫–∏–µ (35%) ---
        (10, "üîÑ –ö–∞–¥—Ä–æ–≤–∏–∫", "–ü–æ–º–µ–Ω—è—Ç—å—Å—è –ø—Ä–æ—Ñ–µ—Å—Å–∏—è–º–∏ —Å –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–æ–º (–≤ –∑–∞–∫—Ä—ã—Ç—É—é).", "swap", "üîÑ"),
        (10, "üõ°Ô∏è –ñ–µ–ª–µ–∑–Ω—ã–π –∑–∞–Ω–∞–≤–µ—Å", "–í—ã —Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å –Ω–µ—É—è–∑–≤–∏–º—ã –¥–ª—è –õ–Æ–ë–´–• –∫–∞—Ä—Ç –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ 1 —Ä–∞—É–Ω–¥.", "shield", "üõ°Ô∏è"),
        (10, "ü§ê –ö–ª—è–ø", "–í—ã–±—Ä–∞–Ω–Ω—ã–π –∏–≥—Ä–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–∏ –∫–∞—Ä—Ç—ã –∏ –∫–Ω–æ–ø–∫–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ.", "silence", "ü§ê"),
        (5, "üó≥Ô∏è –í–±—Ä–æ—Å –±—é–ª–ª–µ—Ç–µ–Ω–µ–π", "–í–∞—à –≥–æ–ª–æ—Å –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞ –¥–≤–∞.", "double_vote", "üó≥Ô∏è"),

        # --- –≠–ø–∏—á–µ—Å–∫–∏–µ (20%) ---
        (10, "üé≤ –†–µ—Ä–æ–ª–ª —Å—É–¥—å–±—ã", "–¢–∞–π–Ω–æ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–µ–±–µ –ó–î–û–†–û–í–¨–ï –∏–ª–∏ –§–û–ë–ò–Æ (–Ω–∞ –≤—ã–±–æ—Ä).", "reroll", "üé≤"),
        (10, "‚öñÔ∏è –°—É–¥—å—è –î—Ä–µ–¥–¥", "–õ–ò–ß–ù–û –≤—ã–±—Ä–∞—Ç—å —Ç–æ–≥–æ, –∫—Ç–æ –ø–æ–∫–∏–Ω–µ—Ç –±—É–Ω–∫–µ—Ä –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å (–±–µ–∑ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è).", "kick", "‚öñÔ∏è"),
    ]
    
    total = sum(w for w, *c in pool)
    r = random.uniform(0, total)
    upto = 0
    for w, name, desc, effect, icon in pool:
        if upto + w >= r:
            return SpecialCard(str(uuid.uuid4()), name, desc, effect, icon)
        upto += w
    return pool[0][1] # Fallback

def generate_player(user: types.User) -> Player:
    p = Player(user_id=user.id, full_name=user.full_name, username=user.username or "Unknown")
    
    p.profession = GameAttribute(text=random.choice(CONTENT["professions"]))
    p.health = GameAttribute(text=random.choice(CONTENT["health"]))
    
    age = random.randint(18, 90)
    gender = random.choice(["–ú—É–∂—á–∏–Ω–∞", "–ñ–µ–Ω—â–∏–Ω–∞"])
    fertility_chance = 0.8 if age < 45 else 0.1
    fertility = "–ü–ª–æ–¥–µ–Ω(–Ω–∞)" if random.random() < fertility_chance else "–ë–µ—Å–ø–ª–æ–¥–µ–Ω(–Ω–∞)"
    
    p.bio = GameAttribute(text=f"{gender}, {age} –ª–µ—Ç, {fertility}", metadata={"age": age})
    p.hobby = GameAttribute(text=random.choice(CONTENT["hobbies"]))
    p.fact = GameAttribute(text=random.choice(CONTENT["facts"]))
    p.phobia = GameAttribute(text=random.choice(CONTENT["phobia"]))
    
    # 2 –ø—Ä–µ–¥–º–µ—Ç–∞ –±–∞–≥–∞–∂–∞
    items = random.sample(CONTENT["luggage"], 2)
    for item in items:
        p.luggage.append(GameAttribute(text=item))
        
    # 2 —Å–ø–µ—Ü–∫–∞—Ä—Ç—ã –¥–ª—è –±–æ–ª—å—à–µ–≥–æ —ç–∫—à–µ–Ω–∞
    for _ in range(2):
        p.action_cards.append(get_random_card())
    
    return p

def reset_round_effects(game: GameSession):
    """–°–±—Ä–æ—Å –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º —Ä–∞—É–Ω–¥–æ–º"""
    game.voters.clear()
    game.votes.clear()
    for p in game.players.values():
        if p.is_alive:
            p.vote_weight = 1
            p.is_shielded = False
            p.is_silenced = False

# ==========================================
# 5. UI: –î–ê–®–ë–û–†–î –ò –ö–ù–û–ü–ö–ò
# ==========================================

def render_dashboard_text(player: Player) -> str:
    if not player.is_alive:
        return "üíÄ **–í–´ –ú–ï–†–¢–í–´ / –ò–ó–ì–ù–ê–ù–´** üíÄ\n\n–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞–±–ª—é–¥–∞—Ç—å –∑–∞ –∏–≥—Ä–æ–π, –Ω–æ –Ω–µ –≤–º–µ—à–∏–≤–∞—Ç—å—Å—è."

    icon_map = {True: "üì¢", False: "üîí"}
    
    t = f"üìÇ **–õ–ò–ß–ù–û–ï –î–ï–õ–û: {player.full_name}**\n"
    
    # –°—Ç–∞—Ç—É—Å—ã
    status_line = []
    if player.vote_weight > 1: status_line.append("üó≥Ô∏èx2 –ì–æ–ª–æ—Å")
    if player.is_shielded: status_line.append("üõ°Ô∏è –ü–æ–¥ –∑–∞—â–∏—Ç–æ–π")
    if player.is_silenced: status_line.append("ü§ê –ú–æ–ª—á–∞–Ω–∏–µ")
    if status_line:
        t += f"–°—Ç–∞—Ç—É—Å: {' | '.join(status_line)}\n"

    t += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    
    attrs = [
        ("üßë‚Äçüíº –ü—Ä–æ—Ñ–µ—Å—Å–∏—è", player.profession),
        ("üß¨ –ë–∏–æ–ª–æ–≥–∏—è", player.bio),
        ("‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ", player.health),
        ("üé® –•–æ–±–±–∏", player.hobby),
        ("üí° –§–∞–∫—Ç", player.fact),
        ("üò± –§–æ–±–∏—è", player.phobia)
    ]
    
    for label, attr in attrs:
        prefix = icon_map[attr.is_revealed]
        # –ï—Å–ª–∏ —Ä–∞—Å–∫—Ä—ã—Ç–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∂–∏—Ä–Ω—ã–º, –∏–Ω–∞—á–µ –∫—É—Ä—Å–∏–≤–æ–º (—Å–∫—Ä—ã—Ç–æ)
        val = f"**{attr.text}**" if attr.is_revealed else f"_{attr.text}_"
        t += f"{prefix} {label}: {val}\n"
    
    t += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    t += "üéí **–ò–ù–í–ï–ù–¢–ê–†–¨:**\n"
    if not player.luggage:
        t += "_–ü—É—Å—Ç–æ..._\n"
    for item in player.luggage:
        prefix = icon_map[item.is_revealed]
        val = f"**{item.text}**" if item.is_revealed else f"_{item.text}_"
        t += f"{prefix} ‚ñ´Ô∏è {val}\n"
        
    t += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    cards_active = [c for c in player.action_cards if not c.is_used]
    t += f"üÉè **–°–ü–ï–¶–ö–ê–†–¢–´ ({len(cards_active)}):**\n"
    if not cards_active:
        t += "_–ù–µ—Ç –∫–∞—Ä—Ç_\n"
    for c in cards_active:
        t += f"{c.icon} **{c.name}** ‚Äî _{c.description}_\n"
        
    return t

def get_main_kb(player: Player) -> InlineKeyboardMarkup:
    if not player.is_alive: return None
    b = InlineKeyboardBuilder()
    
    # –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π, –µ—Å–ª–∏ –Ω–∞–ª–æ–∂–µ–Ω "–ö–ª—è–ø"
    if player.is_silenced:
         b.button(text="ü§ê –ù–∞ –≤–∞—Å –∫–ª—è–ø (–î–µ–π—Å—Ç–≤–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã)", callback_data="dummy_silenced")
    else:
        b.button(text="üó£Ô∏è –†–∞—Å–∫—Ä—ã—Ç—å –ø—Ä–∞–≤–¥—É", callback_data="menu_reveal")
        b.button(text="üÉè –°—ã–≥—Ä–∞—Ç—å –∫–∞—Ä—Ç—É", callback_data="menu_cards")
        
    b.button(text="üéí –ü–æ–∫–∞–∑–∞—Ç—å –±–∞–≥–∞–∂", callback_data="do_reveal:luggage")
    b.button(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞—à–±–æ—Ä–¥", callback_data="refresh")
    b.adjust(1)
    return b.as_markup()

def get_reveal_kb(player: Player) -> InlineKeyboardMarkup:
    b = InlineKeyboardBuilder()
    attrs = [("prof", player.profession, "üßë‚Äçüíº –ü—Ä–æ—Ñ–µ—Å—Å–∏—è"), 
             ("health", player.health, "‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ"),
             ("bio", player.bio, "üß¨ –ë–∏–æ–ª–æ–≥–∏—è"), 
             ("hobby", player.hobby, "üé® –•–æ–±–±–∏"),
             ("fact", player.fact, "üí° –§–∞–∫—Ç"), 
             ("phobia", player.phobia, "üò± –§–æ–±–∏—è")]
    
    for code, attr, label in attrs:
        if not attr.is_revealed:
            b.button(text=f"–†–∞—Å–∫—Ä—ã—Ç—å: {label}", callback_data=f"do_reveal:{code}")
        else:
             b.button(text=f"‚úÖ {label} —Ä–∞—Å–∫—Ä—ã—Ç–æ", callback_data="dummy_revealed")
            
    b.button(text="üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="back_main")
    b.adjust(2)
    return b.as_markup()

# ==========================================
# 6. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò (HANDLERS)
# ==========================================

@dp.message(Command("start"))
async def cmd_start(m: Message):
    await m.answer("üëã –Ø –±–æ—Ç-–≤–µ–¥—É—â–∏–π –∏–≥—Ä—ã ¬´–ë—É–Ω–∫–µ—Ä¬ª.\n\n"
                   "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É:\n1. –î–æ–±–∞–≤—å –º–µ–Ω—è –≤ –≥—Ä—É–ø–ø—É.\n2. –ù–∞–ø–∏—à–∏ —Ç–∞–º –∫–æ–º–∞–Ω–¥—É /new_game")

# --- –ì–†–£–ü–ü–û–í–´–ï –ö–û–ú–ê–ù–î–´ ---

@dp.message(Command("new_game"))
async def cmd_new(m: Message):
    if m.chat.type == 'private':
        return await m.answer("–≠—Ç—É –∫–æ–º–∞–Ω–¥—É –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å –≤ –≥—Ä—É–ø–ø–µ, –≥–¥–µ –±—É–¥–µ—Ç –∏–≥—Ä–∞!")
        
    GAMES[m.chat.id] = GameSession(chat_id=m.chat.id)
    
    kb = InlineKeyboardBuilder()
    kb.button(text="‚úÖ –í—Å—Ç—É–ø–∏—Ç—å –≤ –∏–≥—Ä—É", callback_data="join")
    
    await m.answer("‚ò¢Ô∏è **–ù–û–í–ê–Ø –ò–ì–†–ê: –ë–£–ù–ö–ï–†** ‚ò¢Ô∏è\n\n"
                   "–ù–∞–±–æ—Ä –∏–≥—Ä–æ–∫–æ–≤ –æ—Ç–∫—Ä—ã—Ç! –ñ–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤ –õ–°.", 
                   reply_markup=kb.as_markup(), parse_mode="Markdown")

@dp.callback_query(F.data == "join")
async def cb_join(cb: CallbackQuery):
    game = GAMES.get(cb.message.chat.id)
    if not game or game.state != "LOBBY": 
        return await cb.answer("–ù–∞–±–æ—Ä –∑–∞–∫—Ä—ã—Ç!", show_alert=True)
    
    if cb.from_user.id in game.players:
        return await cb.answer("–¢—ã —É–∂–µ –≤ –∏–≥—Ä–µ!", show_alert=True)
        
    p = generate_player(cb.from_user)
    game.players[cb.from_user.id] = p
    USER_SESSIONS[cb.from_user.id] = game.chat_id
    
    await cb.answer("–ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–æ–∑–¥–∞–Ω! –ü—Ä–æ–≤–µ—Ä—å –ª–∏—á–∫—É.")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–±–±–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
    players_list = "\n".join([f"{i+1}. {pl.full_name}" for i, pl in enumerate(game.players.values())])
    await cb.message.edit_text(
        f"‚ò¢Ô∏è **–ò–ì–†–û–ö–û–í –í –õ–û–ë–ë–ò: {len(game.players)}**\n\n{players_list}\n\n–ñ–¥–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö...",
        reply_markup=cb.message.reply_markup, parse_mode="Markdown"
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞—à–±–æ—Ä–¥ –≤ –õ–°
    try:
        msg = await bot.send_message(p.user_id, render_dashboard_text(p), 
                                     reply_markup=get_main_kb(p), parse_mode="Markdown")
        p.dashboard_msg_id = msg.message_id
    except TelegramForbiddenError:
        await cb.message.answer(f"‚ùå {p.full_name}, —É —Ç–µ–±—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –±–æ—Ç! –ù–∞–ø–∏—à–∏ –º–Ω–µ –≤ –õ–° /start –∏ –ø–æ–ø—Ä–æ–±—É–π –≤—Å—Ç—É–ø–∏—Ç—å —Å–Ω–æ–≤–∞.")
        del game.players[cb.from_user.id]
        del USER_SESSIONS[cb.from_user.id]

@dp.message(Command("start_game"))
async def cmd_start_game(m: Message):
    game = GAMES.get(m.chat.id)
    if not game or game.state != "LOBBY": return
    if len(game.players) < 2:
        return await m.answer("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞!")

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—ã
    game.scenario = random.choice(CATASTROPHES)
    game.state = "GAME"
    game.round_number = 1
    reset_round_effects(game)

    await m.answer(
        f"üî• **–ë–£–ù–ö–ï–† –ó–ê–ü–ï–ß–ê–¢–ê–ù! –ò–ì–†–ê –ù–ê–ß–ê–õ–ê–°–¨!** üî•\n\n"
        f"üåç **–°–ò–¢–£–ê–¶–ò–Ø –°–ù–ê–†–£–ñ–ò:**\n{game.scenario}\n\n"
        f"üë• **–í—ã–∂–∏–≤—à–∏–µ ({len(game.players)}):**\n"
        f"–î–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ —Å–≤–æ—é –ø–æ–ª–µ–∑–Ω–æ—Å—Ç—å, —Ä–∞—Å–∫—Ä—ã–≤–∞–π—Ç–µ –∫–∞—Ä—Ç—ã —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ –õ–°.\n"
        f"–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å ‚Äî –≤–µ–¥—É—â–∏–π –ø–∏—à–µ—Ç /vote",
        parse_mode="Markdown"
    )
    # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—à–±–æ—Ä–¥—ã –≤—Å–µ–º, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ (–µ—Å–ª–∏ –±—ã–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã)
    for p in game.players.values():
        await refresh_dash(p.user_id)


# --- –õ–ò–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø (–í –õ–°) ---

async def refresh_dash(user_id: int):
    chat_id = USER_SESSIONS.get(user_id)
    if not chat_id: return
    game = GAMES.get(chat_id)
    if not game: return
    p = game.players.get(user_id)
    if not p or not p.dashboard_msg_id: return
    
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º edit_message_text, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è
        current_text = render_dashboard_text(p)
        current_kb = get_main_kb(p)
        
        # –ù–µ–±–æ–ª—å—à–æ–π —Ö–∞–∫: aiogram –Ω–µ –¥–∞—Å—Ç –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Ç–æ—á–Ω–æ —Ç–∞–∫–æ–µ –∂–µ.
        # –ß—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å" –≤—Å–µ–≥–¥–∞ –¥–∞–≤–∞–ª–∞ —Ñ–∏–¥–±–µ–∫, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–µ–≤–∏–¥–∏–º—ã–π —Å–∏–º–≤–æ–ª –∫ —Ç–µ–∫—Å—Ç—É,
        # –Ω–æ –ø—Ä–æ—â–µ –ø—Ä–æ—Å—Ç–æ –ª–æ–≤–∏—Ç—å –æ—à–∏–±–∫—É "message is not modified".
        await bot.edit_message_text(
            current_text, 
            chat_id=user_id, 
            message_id=p.dashboard_msg_id,
            reply_markup=current_kb, 
            parse_mode="Markdown"
        )
    except Exception as e:
        # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
        if "message is not modified" not in str(e):
             logging.warning(f"Could not refresh dash for {user_id}: {e}")


@dp.callback_query(F.data == "refresh")
async def cb_ref(cb: CallbackQuery):
    await refresh_dash(cb.from_user.id)
    await cb.answer("–î–∞—à–±–æ—Ä–¥ –æ–±–Ω–æ–≤–ª–µ–Ω!")

@dp.callback_query(F.data == "dummy_silenced")
async def cb_dummy_s(cb: CallbackQuery):
    await cb.answer("‚õî –ù–∞ –≤–∞—Å –Ω–∞–ª–æ–∂–µ–Ω –∫–ª—è–ø! –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ.", show_alert=True)

@dp.callback_query(F.data == "dummy_revealed")
async def cb_dummy_r(cb: CallbackQuery):
    await cb.answer("–≠—Ç–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ —É–∂–µ —Ä–∞—Å–∫—Ä—ã—Ç–∞ –≤—Å–µ–º.", show_alert=True)

@dp.callback_query(F.data == "back_main")
async def cb_back(cb: CallbackQuery):
    game = GAMES[USER_SESSIONS[cb.from_user.id]]
    p = game.players[cb.from_user.id]
    await cb.message.edit_reply_markup(reply_markup=get_main_kb(p))

@dp.callback_query(F.data == "menu_reveal")
async def cb_menu_rev(cb: CallbackQuery):
    uid = cb.from_user.id
    game = GAMES[USER_SESSIONS[uid]]
    p = game.players[uid]
    if p.is_silenced: return await cb.answer("‚õî –ö–ª—è–ø –º–µ—à–∞–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å!", show_alert=True)
    await cb.message.edit_reply_markup(reply_markup=get_reveal_kb(p))

@dp.callback_query(F.data.startswith("do_reveal:"))
async def cb_do_rev(cb: CallbackQuery):
    code = cb.data.split(":")[1]
    uid = cb.from_user.id
    game = GAMES[USER_SESSIONS[uid]]
    p = game.players[uid]
    
    if p.is_silenced: return await cb.answer("‚õî –ö–ª—è–ø –º–µ—à–∞–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å!", show_alert=True)

    attr_map = {
        "prof": ("üßë‚Äçüíº –ü—Ä–æ—Ñ–µ—Å—Å–∏—è", p.profession), "health": ("‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ", p.health),
        "bio": ("üß¨ –ë–∏–æ–ª–æ–≥–∏—è", p.bio), "hobby": ("üé® –•–æ–±–±–∏", p.hobby),
        "fact": ("üí° –§–∞–∫—Ç", p.fact), "phobia": ("üò± –§–æ–±–∏—è", p.phobia)
    }
    
    txt = ""
    if code == "luggage":
        if not p.luggage: return await cb.answer("–ë–∞–≥–∞–∂ –ø—É—Å—Ç!")
        for i in p.luggage: i.is_revealed = True
        txt = f"üéí **{p.full_name}** –≤—ã—Ç—Ä—è—Ö–∏–≤–∞–µ—Ç —Ä—é–∫–∑–∞–∫ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ–º —Å–≤–æ–∏ –≤–µ—â–∏:\n" + \
              "\n".join([f"- {i.text}" for i in p.luggage])
    elif code in attr_map:
        name, attr = attr_map[code]
        if attr.is_revealed: return await cb.answer("–£–∂–µ —Ä–∞—Å–∫—Ä—ã—Ç–æ!")
        attr.is_revealed = True
        txt = f"üó£ **{p.full_name}** —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç—ã:\n\nüëâ **{name}:** {attr.text}"
    
    await bot.send_message(game.chat_id, txt, parse_mode="Markdown")
    await refresh_dash(uid)
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –º–µ–Ω—é —Ä–∞—Å–∫—Ä—ã—Ç–∏—è
    await cb.message.edit_reply_markup(reply_markup=get_reveal_kb(p))
    await cb.answer("–†–∞—Å–∫—Ä—ã—Ç–æ!")

# --- –°–õ–û–ñ–ù–ê–Ø –õ–û–ì–ò–ö–ê –ö–ê–†–¢ ---

@dp.callback_query(F.data == "menu_cards")
async def cb_menu_cards(cb: CallbackQuery):
    uid = cb.from_user.id
    game = GAMES[USER_SESSIONS[uid]]
    p = game.players[uid]

    if p.is_silenced: return await cb.answer("‚õî –ö–ª—è–ø –º–µ—à–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—ã!", show_alert=True)
    
    active = [c for c in p.action_cards if not c.is_used]
    if not active: return await cb.answer("–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç!", show_alert=True)
    
    b = InlineKeyboardBuilder()
    for c in active:
        b.button(text=f"{c.icon} {c.name}", callback_data=f"sel_card:{c.uid}")
    b.button(text="üîô –ù–∞–∑–∞–¥", callback_data="back_main")
    b.adjust(1)
    await cb.message.edit_reply_markup(reply_markup=b.as_markup())

@dp.callback_query(F.data.startswith("sel_card:"))
async def cb_sel_card(cb: CallbackQuery):
    c_uid = cb.data.split(":")[1]
    uid = cb.from_user.id
    game = GAMES[USER_SESSIONS[uid]]
    initiator = game.players[uid]
    card = next((c for c in initiator.action_cards if c.uid == c_uid), None)

    if initiator.is_silenced: return await cb.answer("‚õî –ö–ª—è–ø!", show_alert=True)
    
    # –ö–∞—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ–±—è
    self_target_types = ["double_vote", "shield", "reroll"]

    if card.effect_type in self_target_types:
        # –°—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è–µ–º, –±–µ–∑ –≤—ã–±–æ—Ä–∞ —Ü–µ–ª–∏
        await apply_card_effect(game, initiator, initiator, card)
        await cb.answer("–ö–∞—Ä—Ç–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!")
        await refresh_dash(uid) # –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        return

    # –ö–∞—Ä—Ç—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –≤—ã–±–æ—Ä–∞ —Ü–µ–ª–∏
    b = InlineKeyboardBuilder()
    for pid, target in game.players.items():
        if target.is_alive and pid != uid: # –ù–µ–ª—å–∑—è –Ω–∞ —Å–µ–±—è
            b.button(text=f"{target.full_name}", callback_data=f"act_card:{c_uid}:{pid}")
            
    b.button(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="back_main")
    b.adjust(2)
    await cb.message.edit_text(f"üéØ –í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å –¥–ª—è –∫–∞—Ä—Ç—ã ¬´{card.name}¬ª:", reply_markup=b.as_markup())

@dp.callback_query(F.data.startswith("act_card:"))
async def cb_act_card(cb: CallbackQuery):
    _, c_uid, t_id = cb.data.split(":")
    t_id = int(t_id)
    uid = cb.from_user.id
    game = GAMES[USER_SESSIONS[uid]]
    initiator = game.players[uid]
    target = game.players[t_id]
    
    card = next((c for c in initiator.action_cards if c.uid == c_uid), None)
    
    if initiator.is_silenced: return await cb.answer("‚õî –ö–ª—è–ø!", show_alert=True)
    if not card or card.is_used: return await cb.answer("–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã", show_alert=True)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —â–∏—Ç–∞ —É —Ü–µ–ª–∏
    if target.is_shielded and card.effect_type not in ["reveal", "heal"]: # –©–∏—Ç –Ω–µ —Å–ø–∞—Å–∞–µ—Ç –æ—Ç –ª–µ—á–µ–Ω–∏—è –∏ —Å–∫–∞–Ω–∞ (–¥–ª—è –±–∞–ª–∞–Ω—Å–∞)
         card.is_used = True
         await bot.send_message(game.chat_id, f"üõ°Ô∏è **{initiator.full_name}** –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É ¬´{card.name}¬ª –Ω–∞ **{target.full_name}**, –Ω–æ –Ω–∞—Ç—ã–∫–∞–µ—Ç—Å—è –Ω–∞ –ñ–µ–ª–µ–∑–Ω—ã–π –∑–∞–Ω–∞–≤–µ—Å! –ö–∞—Ä—Ç–∞ –ø–æ—Ç—Ä–∞—á–µ–Ω–∞ –≤–ø—É—Å—Ç—É—é.", parse_mode="Markdown")
         await refresh_dash(uid)
         await cb.answer("–¶–µ–ª—å –∑–∞—â–∏—â–µ–Ω–∞!")
         return

    await apply_card_effect(game, initiator, target, card)
    await cb.answer("–ö–∞—Ä—Ç–∞ —Å—ã–≥—Ä–∞–Ω–∞!")
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞—à–±–æ—Ä–¥ –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await refresh_dash(uid)

# --- –õ–û–ì–ò–ö–ê –≠–§–§–ï–ö–¢–û–í –ö–ê–†–¢ ---

async def apply_card_effect(game: GameSession, initiator: Player, target: Player, card: SpecialCard):
    log = ""
    chat_alert = True

    if card.effect_type == "heal":
        target.health.text = "–ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–¥–æ—Ä–æ–≤ (–í—ã–ª–µ—á–µ–Ω –ø–∞–Ω–∞—Ü–µ–µ–π)"
        target.health.is_revealed = True
        log = f"üíâ **{initiator.full_name}** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ü–∞–Ω–∞—Ü–µ—é –Ω–∞ **{target.full_name}**! –¢–µ–ø–µ—Ä—å –æ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–¥–æ—Ä–æ–≤ –∏ —ç—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ."
        await refresh_dash(target.user_id)

    elif card.effect_type == "reveal":
        info = f"ü©ª **–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–µ–Ω—Ç–≥–µ–Ω–∞ {target.full_name}:**\n\n" \
               f"‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ: {target.health.text}\n" \
               f"üß¨ –ë–∏–æ–ª–æ–≥–∏—è: {target.bio.text}\n" \
               f"üò± –§–æ–±–∏—è: {target.phobia.text}"
        await bot.send_message(initiator.user_id, info)
        log = f"ü©ª **{initiator.full_name}** –ø—Ä–æ—Å–≤–µ—á–∏–≤–∞–µ—Ç —Ä–µ–Ω—Ç–≥–µ–Ω–æ–º –∏–≥—Ä–æ–∫–∞ **{target.full_name}**, —É–∑–Ω–∞–≤–∞—è –µ–≥–æ —Å–µ–∫—Ä–µ—Ç—ã."
        chat_alert = False # –ù–µ —Å–ø–∞–º–∏–º –≤ —á–∞—Ç –¥–µ—Ç–∞–ª—è–º–∏

    elif card.effect_type == "kick":
        target.is_alive = False
        log = f"‚öñÔ∏è **–ü–†–ò–ì–û–í–û–† –°–£–î–¨–ò –î–†–ï–î–î–ê!**\n\n–ò–≥—Ä–æ–∫ **{initiator.full_name}** –∫–∞–∑–Ω–∏—Ç –∏–≥—Ä–æ–∫–∞ **{target.full_name}** –Ω–∞ –º–µ—Å—Ç–µ.\n–û–Ω –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∏–∑ –±—É–Ω–∫–µ—Ä–∞."
        await refresh_dash(target.user_id)

    elif card.effect_type == "steal":
        if target.luggage:
            item = target.luggage.pop(0) # –ö—Ä–∞–¥–µ–º –ø–µ—Ä–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç
            item.is_revealed = False # –ù–æ–≤—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç –µ–≥–æ —Å–∫—Ä—ã—Ç—å
            initiator.luggage.append(item)
            log = f"üß§ **{initiator.full_name}** –Ω–µ–∑–∞–º–µ—Ç–Ω–æ –æ–±—á–∏—Å—Ç–∏–ª –∫–∞—Ä–º–∞–Ω—ã **{target.full_name}** –∏ —É–∫—Ä–∞–ª –æ–¥–∏–Ω –ø—Ä–µ–¥–º–µ—Ç!"
            await refresh_dash(target.user_id)
        else:
            log = f"üß§ **{initiator.full_name}** –ø–æ—à–∞—Ä–∏–ª –ø–æ –∫–∞—Ä–º–∞–Ω–∞–º {target.full_name}, –Ω–æ —Ç–∞–º —Ç–æ–ª—å–∫–æ –¥—ã—Ä–∫–∏."

    elif card.effect_type == "swap":
        # –û–±–º–µ–Ω –ø—Ä–æ—Ñ–µ—Å—Å–∏—è–º–∏ –≤ –∑–∞–∫—Ä—ã—Ç—É—é
        p1_prof = initiator.profession
        p2_prof = target.profession
        # –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç—ã, —Å–æ—Ö—Ä–∞–Ω—è—è —Å—Ç–∞—Ç—É—Å —Ä–∞—Å–∫—Ä—ã—Ç–∏—è (–∏–ª–∏ —Å–±—Ä–∞—Å—ã–≤–∞—è –µ–≥–æ –¥–ª—è –∏–Ω—Ç—Ä–∏–≥–∏)
        initiator.profession = p2_prof
        target.profession = p1_prof
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è, —á—Ç–æ–±—ã –∏–Ω—Ç—Ä–∏–≥–∞ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞—Å—å
        initiator.profession.is_revealed = False
        target.profession.is_revealed = False
        
        log = f"üîÑ **–ö–ê–î–†–û–í–ê–Ø –ü–ï–†–ï–°–¢–ê–ù–û–í–ö–ê!**\n**{initiator.full_name}** –∏ **{target.full_name}** –ø–æ–º–µ–Ω—è–ª–∏—Å—å –ø—Ä–æ—Ñ–µ—Å—Å–∏—è–º–∏ –∏ –±–µ–π–¥–∂–∏–∫–∞–º–∏ –≤ —Å—É–º–∞—Ç–æ—Ö–µ. –ù–∏–∫—Ç–æ –Ω–µ –∑–Ω–∞–µ—Ç, –∫—Ç–æ –æ–Ω–∏ —Ç–µ–ø–µ—Ä—å!"
        await refresh_dash(target.user_id)

    # --- –ù–û–í–´–ï –≠–§–§–ï–ö–¢–´ ---
    elif card.effect_type == "silence":
        target.is_silenced = True
        log = f"ü§ê **{initiator.full_name}** –≤—Å—Ç–∞–≤–ª—è–µ—Ç –∫–ª—è–ø –≤ —Ä–æ—Ç **{target.full_name}**! –≠—Ç–æ—Ç –∏–≥—Ä–æ–∫ –Ω–µ —Å–º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—ã –∏ –≥–æ–≤–æ—Ä–∏—Ç—å –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ."
        await refresh_dash(target.user_id)

    elif card.effect_type == "shield":
        initiator.is_shielded = True
        log = f"üõ°Ô∏è **{initiator.full_name}** –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç ¬´–ñ–µ–ª–µ–∑–Ω—ã–π –∑–∞–Ω–∞–≤–µ—Å¬ª! –û–Ω –Ω–µ—É—è–∑–≤–∏–º –¥–ª—è —á—É–∂–∏—Ö –∫–∞—Ä—Ç –¥–æ –∫–æ–Ω—Ü–∞ —Ä–∞—É–Ω–¥–∞."
        # –î–∞—à–±–æ—Ä–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ —Ö–µ–Ω–¥–ª–µ—Ä–∞ cb_sel_card

    elif card.effect_type == "double_vote":
        initiator.vote_weight = 2
        log = f"üó≥Ô∏è **{initiator.full_name}** –≥–æ—Ç–æ–≤–∏—Ç –≤–±—Ä–æ—Å –±—é–ª–ª–µ—Ç–µ–Ω–µ–π! –ï–≥–æ –≥–æ–ª–æ—Å –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏ –±—É–¥–µ—Ç –∏–º–µ—Ç—å –¥–≤–æ–π–Ω—É—é —Å–∏–ª—É."

    elif card.effect_type == "reroll":
        # –ú–µ—Ö–∞–Ω–∏–∫–∞ —Ä–µ—Ä–æ–ª–ª–∞ (–ó–¥–æ—Ä–æ–≤—å–µ –∏–ª–∏ –§–æ–±–∏—è)
        new_health = random.choice(CONTENT["health"])
        new_phobia = random.choice(CONTENT["phobia"])
        
        initiator.health = GameAttribute(text=new_health, is_revealed=False)
        initiator.phobia = GameAttribute(text=new_phobia, is_revealed=False)
        
        await bot.send_message(
            initiator.user_id,
            f"üé≤ **–°–£–î–¨–ë–ê –ò–ó–ú–ï–ù–ï–ù–ê!**\n\n"
            f"–í–∞—à–µ –Ω–æ–≤–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ: {new_health}\n"
            f"–í–∞—à–∞ –Ω–æ–≤–∞—è —Ñ–æ–±–∏—è: {new_phobia}\n\n"
            f"_(–°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç–µ—Ä—Ç—ã, –Ω–æ–≤—ã–µ —Å–∫—Ä—ã—Ç—ã)_"
        )
        log = f"üé≤ **{initiator.full_name}** —Ç–∞–π–Ω–æ –∏–∑–º–µ–Ω–∏–ª —Å–≤–æ—é —Å—É–¥—å–±—É (–ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª —á–∞—Å—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫)."
        chat_alert = False

    card.is_used = True
    if chat_alert:
         await bot.send_message(game.chat_id, log, parse_mode="Markdown")

# --- –ì–û–õ–û–°–û–í–ê–ù–ò–ï (–ò–°–ü–†–ê–í–õ–ï–ù–û) ---

@dp.message(Command("vote"))
async def cmd_vote(m: Message):
    game = GAMES.get(m.chat.id)
    if not game or game.state != "GAME": return
    
    game.state = "VOTING"
    game.votes = {}
    game.voters = set() # –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–∏—Ö
    
    b = InlineKeyboardBuilder()
    alive_players = [p for p in game.players.values() if p.is_alive]
    for p in alive_players:
        b.button(text=f"{p.full_name}", callback_data=f"vote:{p.user_id}")
    b.adjust(2)
    
    await m.answer(
        f"üó≥ **–ì–û–õ–û–°–û–í–ê–ù–ò–ï –†–ê–£–ù–î–ê {game.round_number} –û–¢–ö–†–´–¢–û!**\n\n"
        "–ö—Ç–æ –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∏–Ω—É—Ç—å –±—É–Ω–∫–µ—Ä? –í—ã–±–∏—Ä–∞–π—Ç–µ –º—É–¥—Ä–æ, —É –≤–∞—Å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –≥–æ–ª–æ—Å.", 
        reply_markup=b.as_markup(), parse_mode="Markdown"
    )

@dp.callback_query(F.data.startswith("vote:"))
async def cb_vote(cb: CallbackQuery):
    t_id = int(cb.data.split(":")[1])
    uid = cb.from_user.id
    game = GAMES.get(cb.message.chat.id)
    
    if not game or game.state != "VOTING":
        return await cb.answer("–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ —Å–µ–π—á–∞—Å –Ω–µ –∏–¥–µ—Ç.", show_alert=True)
        
    voter = game.players[uid]

    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞: –ñ–∏–≤ –ª–∏ –≥–æ–ª–æ—Å—É—é—â–∏–π?
    if not voter.is_alive: 
        return await cb.answer("üíÄ –ú–µ—Ä—Ç–≤—ã–µ –Ω–µ –≥–æ–ª–æ—Å—É—é—Ç!", show_alert=True)

    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞: –ì–æ–ª–æ—Å–æ–≤–∞–ª –ª–∏ –æ–Ω —É–∂–µ? (–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ë–ê–ì–ê)
    if uid in game.voters:
        return await cb.answer("‚õî –í—ã —É–∂–µ –æ—Ç–¥–∞–ª–∏ —Å–≤–æ–π –≥–æ–ª–æ—Å –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ!", show_alert=True)
        
    target = game.players.get(t_id)
    if not target or not target.is_alive:
         return await cb.answer("–≠—Ç–æ—Ç –∏–≥—Ä–æ–∫ —É–∂–µ –Ω–µ –≤ –∏–≥—Ä–µ.")

    # –õ–æ–≥–∏–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —Å —É—á–µ—Ç–æ–º –≤–µ—Å–∞ –≥–æ–ª–æ—Å–∞
    weight = voter.vote_weight
    game.votes[t_id] = game.votes.get(t_id, 0) + weight
    game.voters.add(uid) # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–µ–≥–æ
    
    msg = "‚úÖ –í–∞—à –≥–æ–ª–æ—Å –ø—Ä–∏–Ω—è—Ç!"
    if weight > 1: msg += f" (–°–∏–ª–∞ –≥–æ–ª–æ—Å–∞: {weight})"
    await cb.answer(msg)

@dp.message(Command("finish_vote"))
async def cmd_fin(m: Message):
    game = GAMES.get(m.chat.id)
    if not game or game.state != "VOTING": return
    
    if not game.votes:
        game.state = "GAME" # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –∏–≥—Ä—É
        await m.answer("ü§∑‚Äç‚ôÇÔ∏è –ù–∏–∫—Ç–æ –Ω–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª. –†–∞—É–Ω–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è, –Ω–∏–∫—Ç–æ –Ω–µ –∏–∑–≥–Ω–∞–Ω.")
        reset_round_effects(game)
        # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—à–±–æ—Ä–¥—ã (—Å–±—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–æ–≤)
        for p in game.players.values(): await refresh_dash(p.user_id)
        return
        
    # –ù–∞—Ö–æ–¥–∏–º –∂–µ—Ä—Ç–≤—É (–ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç, –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∏—á—å–µ–π –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏)
    victim_id = max(game.votes, key=game.votes.get)
    victim = game.players[victim_id]
    votes_count = game.votes[victim_id]
    
    victim.is_alive = False
    
    game.state = "GAME"
    game.round_number += 1
    
    # –°–±—Ä–æ—Å —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ —Ä–∞—É–Ω–¥–∞ (—â–∏—Ç—ã, –∫–ª—è–ø—ã, –¥–≤–æ–π–Ω—ã–µ –≥–æ–ª–æ—Å–∞)
    reset_round_effects(game)
    
    await m.answer(
        f"üèÅ **–ì–û–õ–û–°–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!**\n\n"
        f"–° –ø–µ—Ä–µ–≤–µ—Å–æ–º –≤ {votes_count} –≥–æ–ª–æ—Å–æ–≤ –±—É–Ω–∫–µ—Ä –ø–æ–∫–∏–¥–∞–µ—Ç: **{victim.full_name}**.\n\n"
        f"üóÇ **–í–°–ö–†–´–¢–ò–ï –ö–ê–†–¢ –ò–ó–ì–ù–ê–ù–ù–û–ì–û:**\n"
        f"üßë‚Äçüíº –ü—Ä–æ—Ñ–µ—Å—Å–∏—è: {victim.profession.text}\n"
        f"‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ: {victim.health.text}\n"
        f"üß¨ –ë–∏–æ–ª–æ–≥–∏—è: {victim.bio.text}\n"
        f"üí° –§–∞–∫—Ç: {victim.fact.text}\n\n"
        f"üö™ –î–≤–µ—Ä–∏ –±—É–Ω–∫–µ—Ä–∞ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –∑–∞ –Ω–∏–º. –û—Å—Ç–∞–≤—à–∏–µ—Å—è –≤—ã–∂–∏–≤—à–∏–µ, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –†–∞—É–Ω–¥ {game.round_number}.",
        parse_mode="Markdown"
    )
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—à–±–æ—Ä–¥ –∂–µ—Ä—Ç–≤—ã (–ø–æ–∫–∞–∑–∞—Ç—å —Å–º–µ—Ä—Ç—å) –∏ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö (—Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã)
    await refresh_dash(victim_id)
    for p in game.players.values():
        if p.is_alive: await refresh_dash(p.user_id)


# ==========================================
# 7. –ó–ê–ü–£–°–ö
# ==========================================

async def main():
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    # –£–¥–∞–ª—è–µ–º –≤–µ–±—Ö—É–∫ –∏ —á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –∞–ø–¥–µ–π—Ç—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    await bot.delete_webhook(drop_pending_updates=True)
    await dp.start_polling(bot)

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
